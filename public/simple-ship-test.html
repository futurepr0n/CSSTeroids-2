<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Two-Ship Sync Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            background: #000;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            z-index: 100;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            z-index: 100;
        }
        
        button {
            background: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #555;
        }
        
        input {
            background: #333;
            color: white;
            border: 1px solid #666;
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div>Status: <span id="status">Connecting...</span></div>
        <div>Session: <span id="sessionId">None</span></div>
        <div>Your Ship: <span id="myShipId">Unknown</span></div>
        <div>Other Ships: <span id="otherShipCount">0</span></div>
    </div>

    <div id="controls">
        <div>
            <input type="text" id="sessionInput" placeholder="Session ID" value="test123">
            <button onclick="joinSession()">Join Session</button>
        </div>
        <div>Controls: WASD to move, Mouse to rotate</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Simple ship class
        class Ship {
            constructor(x, y, color, isOwnShip = false) {
                this.x = x;
                this.y = y;
                this.angle = 0;
                this.velocity = { x: 0, y: 0 };
                this.color = color;
                this.isOwnShip = isOwnShip;
                this.size = 15;
                this.speed = 300; // pixels per second
                this.rotationSpeed = 4; // radians per second
                this.friction = 0.95;
                this.playerId = null;
            }
            
            update(dt, input = null) {
                if (this.isOwnShip && input) {
                    // Handle rotation based on mouse
                    // (mouse rotation will be handled separately)
                    
                    // Handle thrust
                    if (input.up) {
                        this.velocity.x += Math.cos(this.angle) * this.speed * dt;
                        this.velocity.y += Math.sin(this.angle) * this.speed * dt;
                    }
                    
                    // Apply friction
                    this.velocity.x *= this.friction;
                    this.velocity.y *= this.friction;
                }
                
                // Update position
                this.x += this.velocity.x * dt;
                this.y += this.velocity.y * dt;
                
                // Wrap around screen
                if (this.x < 0) this.x = canvas.width;
                if (this.x > canvas.width) this.x = 0;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
            
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                // Draw ship as triangle
                ctx.strokeStyle = this.color;
                ctx.fillStyle = this.isOwnShip ? this.color : 'transparent';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(this.size, 0);
                ctx.lineTo(-this.size, -this.size/2);
                ctx.lineTo(-this.size/2, 0);
                ctx.lineTo(-this.size, this.size/2);
                ctx.closePath();
                ctx.stroke();
                if (this.isOwnShip) ctx.fill();
                
                ctx.restore();
                
                // Draw player ID above ship
                if (!this.isOwnShip && this.playerId) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(this.playerId.substring(0, 8), this.x, this.y - 25);
                }
            }
            
            getState() {
                return {
                    x: this.x,
                    y: this.y,
                    angle: this.angle,
                    velocity: this.velocity
                };
            }
            
            setState(state) {
                // Smooth interpolation for other players
                if (!this.isOwnShip) {
                    this.x = state.x;
                    this.y = state.y;
                    this.angle = state.angle;
                    this.velocity = state.velocity;
                }
            }
        }

        // Game setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Resize canvas to fill window
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Game state
        let myShip = new Ship(canvas.width / 2, canvas.height / 2, '#00ff00', true);
        let otherShips = new Map();
        let socket = null;
        let currentSessionId = null;
        
        // Input handling
        const input = {
            up: false,
            left: false,
            right: false
        };
        
        let mouseX = 0;
        let mouseY = 0;
        
        // Keyboard input
        window.addEventListener('keydown', (e) => {
            switch(e.key.toLowerCase()) {
                case 'arrowup':
                case 'w':
                    input.up = true;
                    e.preventDefault();
                    break;
                case 'arrowleft':
                case 'a':
                    input.left = true;
                    e.preventDefault();
                    break;
                case 'arrowright':
                case 'd':
                    input.right = true;
                    e.preventDefault();
                    break;
            }
        });
        
        window.addEventListener('keyup', (e) => {
            switch(e.key.toLowerCase()) {
                case 'arrowup':
                case 'w':
                    input.up = false;
                    break;
                case 'arrowleft':
                case 'a':
                    input.left = false;
                    break;
                case 'arrowright':
                case 'd':
                    input.right = false;
                    break;
            }
        });
        
        // Mouse input for rotation
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            
            // Update ship angle to point toward mouse
            const dx = mouseX - myShip.x;
            const dy = mouseY - myShip.y;
            myShip.angle = Math.atan2(dy, dx);
        });
        
        // Socket connection
        function connectSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                myShip.playerId = socket.id;
                updateUI('Connected', currentSessionId, socket.id, otherShips.size);
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateUI('Disconnected', null, null, 0);
                otherShips.clear();
            });
            
            socket.on('session-joined', (data) => {
                console.log('Joined session:', data);
                currentSessionId = data.sessionId;
                updateUI('In Session', data.sessionId, data.playerId, data.playerCount - 1);
            });
            
            socket.on('player-joined', (data) => {
                console.log('Player joined:', data.playerId);
                updateUI('In Session', currentSessionId, socket.id, otherShips.size);
            });
            
            socket.on('player-left', (data) => {
                console.log('Player left:', data.playerId);
                otherShips.delete(data.playerId);
                updateUI('In Session', currentSessionId, socket.id, otherShips.size);
            });
            
            socket.on('player-update', (data) => {
                // Create or update other player ship
                if (data.playerId !== socket.id) {
                    if (!otherShips.has(data.playerId)) {
                        const newShip = new Ship(data.x, data.y, '#ff4444', false);
                        newShip.playerId = data.playerId;
                        otherShips.set(data.playerId, newShip);
                        updateUI('In Session', currentSessionId, socket.id, otherShips.size);
                    }
                    
                    const otherShip = otherShips.get(data.playerId);
                    otherShip.setState(data);
                }
            });
        }
        
        function joinSession() {
            const sessionInput = document.getElementById('sessionInput');
            const sessionToJoin = sessionInput.value.trim();
            
            if (!sessionToJoin) {
                alert('Please enter a session ID');
                return;
            }
            
            if (!socket || !socket.connected) {
                alert('Not connected to server');
                return;
            }
            
            console.log('Joining session:', sessionToJoin);
            socket.emit('join-simple-session', sessionToJoin);
        }
        
        function updateUI(status, sessionId, myId, otherCount) {
            document.getElementById('status').textContent = status;
            document.getElementById('sessionId').textContent = sessionId || 'None';
            document.getElementById('myShipId').textContent = myId ? myId.substring(0, 8) : 'Unknown';
            document.getElementById('otherShipCount').textContent = otherCount;
        }
        
        // Game loop
        let lastTime = 0;
        let lastSyncTime = 0;
        const syncInterval = 1000 / 20; // 20 FPS sync
        
        function gameLoop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            
            // Update my ship
            myShip.update(dt, input);
            
            // Update other ships
            for (const [id, ship] of otherShips) {
                ship.update(dt);
            }
            
            // Send my state to other players
            if (socket && socket.connected && currentSessionId && timestamp - lastSyncTime > syncInterval) {
                const state = myShip.getState();
                socket.emit('player-update', state);
                lastSyncTime = timestamp;
            }
            
            // Render
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars background
            drawStars();
            
            // Draw my ship
            myShip.draw(ctx);
            
            // Draw other players
            for (const [id, ship] of otherShips) {
                ship.draw(ctx);
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function drawStars() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 100; i++) {
                const x = (i * 123.45) % canvas.width;
                const y = (i * 678.91) % canvas.height;
                const size = (i % 3) + 1;
                ctx.beginPath();
                ctx.arc(x, y, size * 0.5, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // Start everything
        connectSocket();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>